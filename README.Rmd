---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# sftpr

<!-- badges: start -->
<!-- badges: end -->

**sftpr** is an R package that provides wrappers to work with SFTP connections.
Its main feature is the ability to wrap any R function that reads or writes
files, making it transparently work with SFTP URLs.

## Installation

You can install the development version of sftpr from [GitHub](https://github.com/SamDM/sftpr) with:

```{r install, eval = FALSE}
# Using pak
# install.packages("pak")
pak::pkg_install("SamDM/sftpr")

# Using remotes
# install.packages("remotes")
remotes::install_github("SamDM/sftpr")

# Using devtools
# install.packages("devtools")
devtools::install_github("SamDM/sftpr")
```

## Wrap file reading/writing functions with `sftp_reader()` and `sftp_writer()`

The main feature of sftpr is wrapping existing R functions to work with SFTP
URLs. You write code as if files were local, and sftpr handles the transfer
behind the scenes.

```{r setup, include = FALSE}
# Setup: ensure clean test directory
library(sftpr)
test_dir <- "/tmp/sftpr-readme-demo"
unlink(test_dir, recursive = TRUE)
dir.create(test_dir, showWarnings = FALSE)

# Base URL for demo (using local SFTP server)
sftp_base <- "sftp://vscode@localhost:2222/tmp/sftpr-readme-demo"
```

### Creating Wrapped Functions

Wrap any file I/O function once, then reuse it:

```{r wrapped-functions}
library(sftpr)

# Create SFTP-enabled versions of common functions
saveRDS_sftp <- sftp_writer(saveRDS)
readRDS_sftp <- sftp_reader(readRDS)

# Use them just like the originals, but with SFTP URLs
sftp_url <- "sftp://vscode@localhost:2222/tmp/sftpr-readme-demo/data.rds"

saveRDS_sftp(mtcars, sftp_url)
remote_data <- readRDS_sftp(sftp_url)

head(remote_data)
```

### One-Off Usage (No Named Function Needed)

For quick operations, chain the wrapper and call directly:

```{r one-off}
# Write a CSV to SFTP in one line
sftp_writer(write.table)(
  iris,
  "sftp://vscode@localhost:2222/tmp/sftpr-readme-demo/iris.csv",
  sep = ",",
  row.names = FALSE
)

# Read it back
iris_remote <- sftp_reader(read.csv)("sftp://vscode@localhost:2222/tmp/sftpr-readme-demo/iris.csv")
head(iris_remote)
```

### Works with Any File I/O Function

The wrappers auto-detect the path argument, or you can specify it explicitly:

```{r explicit-path-arg, eval = FALSE}
# Auto-detection works for most functions
sftp_writer(readr::write_tsv)(df, "sftp://user@host/data.tsv")

# Explicit path argument when needed
sftp_writer(saveRDS, file)(obj, "sftp://user@host/data.rds")
sftp_writer(saveRDS, file)(obj, file = "sftp://user@host/data.rds")
sftp_reader(readRDS, "file")("sftp://user@host/data.rds")
sftp_reader(readRDS, "file")(file = "sftp://user@host/data.rds")
```

### Under the hood

The working principle is very simple.

Running `new_function <- sftp_reader(original_function)` will create a new function that:

1. first downloads the given file using SFTP to a temporary location,
2. then executes `original_function` on the downloaded file,
3. then removes the temporary file.

Running `new_function <- sfpt_writer(original_function)` works the same,
it creates a new function that:

1. first writes to a temporary file using `original_function`,
2. then uploads the file using SFTP,
3. then removes the temporary file.

All arguments except for the file path are passed on the `original_function` without modification.

## All SFTP Functions

| Function | Description |
|----------|-------------|
| `sftp_reader()` | Wrap a file-reading function for SFTP support |
| `sftp_writer()` | Wrap a file-writing function for SFTP support |
| `sftp_get()` | Download a file from SFTP server |
| `sftp_put()` | Upload a file to SFTP server |
| `sftp_ls()` | List files in a remote directory |
| `sftp_stat()` | Get file metadata (size, mtime, permissions) |
| `sftp_exists()` | Check if a file or directory exists |
| `sftp_delete()` | Delete a file |
| `sftp_mkdir()` | Create a directory |
| `sftp_rmdir()` | Remove an empty directory |
| `sftp_rename()` | Rename or move a file |
| `sftp_chmod()` | Change file permissions |

## File Metadata with `sftp_stat()`

Get detailed information about remote files and directories:

```{r stat-setup, include = FALSE}
# Create a subdirectory to demo directory stat
sftp_mkdir("sftp://vscode@localhost:2222/tmp/sftpr-readme-demo/subdir")
```

```{r stat-file}
# Stat a file
sftp_stat("sftp://vscode@localhost:2222/tmp/sftpr-readme-demo/data.rds")
```

```{r stat-dir}
# Stat a directory
sftp_stat("sftp://vscode@localhost:2222/tmp/sftpr-readme-demo/subdir")
```

```{r cleanup, include = FALSE}
# Cleanup
unlink(test_dir, recursive = TRUE)
```

## Requirements

- The `sftp` command-line tool must be available in your PATH
- SSH key authentication configured for passwordless access (recommended)
